<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interview Prep</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>

<body>
    <header class="app-header">
        <button id="history-btn" class="history-trigger">History üìú</button>
        <div class="day-badge" id="day-badge">Day 1</div>
    </header>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>History</h2>
            <ul id="history-list" class="history-list">
                <!-- Items injected here -->
            </ul>
        </div>
    </div>

    <div class="container">
        <h1>Daily Interview Prep</h1>

        <div class="card" id="task-card">
            <span class="tag" id="task-type">Loading...</span>
            <div class="topic-title">
                <a href="#" id="task-link" target="_blank" class="topic-link">Wait for it...</a>
            </div>

            <div class="aha-box">
                <span class="aha-label">The "Aha!" Moment</span>
                <button id="show-hint-btn" class="hint-btn">Show Hint üí°</button>
                <p class="aha-text" id="task-aha" style="display: none;">Your daily wisdom will appear here.</p>
            </div>
        </div>

        <!-- Custom Topic Override -->
        <div class="custom-topic-section" id="custom-topic-section">
            <div class="custom-topic-box" id="custom-topic-box">
                <label class="custom-topic-label" id="custom-topic-label">üéØ Choose Your Own Topic</label>
                <div class="custom-topic-input-row">
                    <input type="text" id="custom-topic-input" class="custom-topic-input"
                        placeholder="e.g. Design a Notification System">
                    <button id="set-topic-btn" class="set-topic-btn">Set</button>
                    <button id="clear-topic-btn" class="clear-topic-btn" style="display: none;">‚úï</button>
                </div>
            </div>
        </div>

        <div class="timer-section">
            <div class="time-display" id="timer">30:00</div>
            <div class="controls">
                <button id="start-btn" class="primary">Start</button>
                <button id="reset-btn">Reset</button>
            </div>
        </div>

        <div class="footer">
            <p>"Consistency is the key to mastery."</p>
        </div>
    </div>

    <script type="module">
        import { codingQuestions, systemDesignTopics } from './data.js';
        import { initSync, pushData, pullData, onDataChange, changeSyncCode, getSyncCode, uploadAllLocal } from './firebase-sync.js';

        // --- Logic Configuration ---
        const START_DATE_KEY = 'interview_prep_start_date';
        // Set this to a fixed date if you want everyone to have the same schedule, 
        // or let it initialize on first run.
        // For consistency, let's fix the anchor date to Feb 11, 2026 as Day 1.
        const ANCHOR_DATE = new Date('2026-02-18T00:00:00');

        function getDayNumber() {
            const now = new Date();
            const diffTime = Math.abs(now - ANCHOR_DATE);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 1;
        }

        // --- Firebase Config ---
        // TODO: Replace with your Firebase project config
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBrYa5yChiJP-m33NjeYzsrWhf0MH4Or6s",
            authDomain: "interview-prep-20845.firebaseapp.com",
            databaseURL: "https://interview-prep-20845-default-rtdb.firebaseio.com",
            projectId: "interview-prep-20845",
            storageBucket: "interview-prep-20845.firebasestorage.app",
            messagingSenderId: "29704314538",
            appId: "1:29704314538:web:8b280582b63dc7f664bad3"
        };

        // --- Persistence Logic (synced via Firebase) ---
        const COMPLETION_KEY = 'interview_prep_log';
        const CUSTOM_TOPIC_KEY = 'interview_prep_custom_topics';

        function loadCompletion() {
            const log = localStorage.getItem(COMPLETION_KEY);
            return log ? JSON.parse(log) : {};
        }

        async function saveDayCompletion(day, isDone) {
            const log = loadCompletion();
            log[day] = isDone;
            await pushData(COMPLETION_KEY, log);
            render();
        }

        function loadCustomTopics() {
            const data = localStorage.getItem(CUSTOM_TOPIC_KEY);
            return data ? JSON.parse(data) : {};
        }

        async function saveCustomTopic(day, topic) {
            const topics = loadCustomTopics();
            if (topic) {
                topics[day] = topic;
            } else {
                delete topics[day];
            }
            await pushData(CUSTOM_TOPIC_KEY, topics);
        }

        // --- Render Updates ---
        function render() {
            const day = getDayNumber();
            document.getElementById('day-badge').textContent = `Day ${day}`;

            const log = loadCompletion();
            const isDone = log[day];

            const task = getTaskForDay(day);

            // Update History Modal if open (or just always for simplicity if cheap)
            renderHistory();

            const typeLabel = document.getElementById('task-type');
            const link = document.getElementById('task-link');
            const aha = document.getElementById('task-aha');
            const showHintBtn = document.getElementById('show-hint-btn');
            const card = document.getElementById('task-card');
            const markDoneBtn = document.getElementById('mark-done-btn');

            if (isDone) {
                card.style.opacity = '0.5';
                if (markDoneBtn) {
                    markDoneBtn.textContent = 'Completed ‚úÖ';
                    markDoneBtn.classList.add('completed');
                }
            } else {
                card.style.opacity = '1';
                if (markDoneBtn) {
                    markDoneBtn.textContent = 'Mark as Done';
                    markDoneBtn.classList.remove('completed');
                }
            }

            typeLabel.textContent = task.type;

            // Custom topic logic for both Coding and System Design days
            const customSection = document.getElementById('custom-topic-section');
            const customBox = document.getElementById('custom-topic-box');
            const customLabel = document.getElementById('custom-topic-label');
            const customInput = document.getElementById('custom-topic-input');
            const setTopicBtn = document.getElementById('set-topic-btn');
            const clearTopicBtn = document.getElementById('clear-topic-btn');
            const customTopics = loadCustomTopics();
            const customTopic = customTopics[day];

            const isCoding = task.type === 'Coding';

            if (isCoding) {
                typeLabel.className = 'tag coding';
                customBox.className = 'custom-topic-box coding-variant';
                customLabel.textContent = 'üéØ Choose Your Own Problem';
                customInput.placeholder = 'e.g. Two Sum or paste LeetCode URL';
            } else {
                typeLabel.className = 'tag system-design';
                customBox.className = 'custom-topic-box';
                customLabel.textContent = 'üéØ Choose Your Own Topic';
                customInput.placeholder = 'e.g. Design a Notification System';
            }

            if (customTopic) {
                // Custom topic is set ‚Äî show it
                const isUrl = customTopic.startsWith('http');
                if (isCoding) {
                    link.href = isUrl ? customTopic : `https://leetcode.com/problemset/?search=${encodeURIComponent(customTopic)}`;
                } else {
                    link.href = `https://www.google.com/search?q=${encodeURIComponent(customTopic + " system design")}`;
                }
                link.textContent = isUrl ? customTopic.split('/').filter(Boolean).pop().replace(/-/g, ' ') : customTopic;
                customInput.value = customTopic;
                setTopicBtn.style.display = 'none';
                clearTopicBtn.style.display = 'inline-flex';
            } else {
                // Default topic
                if (isCoding) {
                    link.href = task.link;
                    link.textContent = task.title;
                } else {
                    link.href = `https://www.google.com/search?q=${encodeURIComponent(task.title + " system design")}`;
                    link.textContent = task.title;
                }
                customInput.value = '';
                setTopicBtn.style.display = 'inline-flex';
                clearTopicBtn.style.display = 'none';
            }

            // AHA Logic - Hide by default
            if (customTopic) {
                aha.textContent = 'You chose this one ‚Äî go crush it!';
            } else {
                aha.textContent = task.aha;
            }
            aha.style.display = 'none'; // Ensure hidden on re-render

            if (showHintBtn) {
                showHintBtn.style.display = 'inline-block';
                const newBtn = showHintBtn.cloneNode(true);
                showHintBtn.parentNode.replaceChild(newBtn, showHintBtn);

                newBtn.onclick = () => {
                    aha.style.display = 'block';
                    newBtn.style.display = 'none';
                };
            }
        }

        function getTaskForDay(day) {
            const isCodingDay = day % 2 !== 0;
            if (isCodingDay) {
                let index = Math.floor((day - 1) / 2);
                index = index % codingQuestions.length;
                return codingQuestions[index];
            } else {
                let index = (day / 2) - 1;
                index = index % systemDesignTopics.length;
                return systemDesignTopics[index];
            }
        }

        // --- Timer Logic with Recovery ---
        let timeLeft = 30 * 60;
        let timerId = null;
        const TIMER_END_KEY = 'interview_timer_end';

        const timerEl = document.getElementById('timer');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updateTimerUp() {
            if (timeLeft < 0) timeLeft = 0;
            timerEl.textContent = formatTime(timeLeft);
        }

        function checkTimerRecovery() {
            const savedEnd = localStorage.getItem(TIMER_END_KEY);
            if (savedEnd) {
                const now = Date.now();
                const diff = Math.ceil((parseInt(savedEnd) - now) / 1000);

                if (diff > 0) {
                    timeLeft = diff;
                    startBtn.textContent = 'Pause';
                    startTimerInterval();
                } else {
                    timeLeft = 0;
                    startBtn.textContent = 'Done';
                    localStorage.removeItem(TIMER_END_KEY);
                }
                updateTimerUp();
            }
        }

        function startTimerInterval() {
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                updateTimerUp();

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    timerId = null;
                    startBtn.textContent = 'Done';
                    localStorage.removeItem(TIMER_END_KEY);

                    if (Notification.permission === 'granted') {
                        new Notification("Time's Up!", { body: "Great job! Don't forget to mark as done." });
                    }
                }
            }, 1000);
        }

        function toggleTimer() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
                startBtn.textContent = 'Start';
                startBtn.className = 'primary';
                localStorage.removeItem(TIMER_END_KEY);
            } else {
                if (timeLeft <= 0) return;
                const now = Date.now();
                const endTimestamp = now + (timeLeft * 1000);
                localStorage.setItem(TIMER_END_KEY, endTimestamp.toString());

                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                startBtn.textContent = 'Pause';
                startBtn.className = '';
                startTimerInterval();
            }
        }

        function resetTimer() {
            if (timerId) clearInterval(timerId);
            timerId = null;
            timeLeft = 30 * 60;
            localStorage.removeItem(TIMER_END_KEY);
            updateTimerUp();
            startBtn.textContent = 'Start';
            startBtn.className = 'primary';
        }

        startBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetTimer);

        // --- Bottom Actions (Mark Done + Export/Import) ---
        // Create wrapper for bottom actions
        const actionWrapper = document.createElement('div');
        actionWrapper.style.display = 'flex';
        actionWrapper.style.flexDirection = 'column';
        actionWrapper.style.gap = '10px';
        actionWrapper.style.width = '100%';
        actionWrapper.style.maxWidth = '300px';
        actionWrapper.style.margin = '20px auto 0';

        // Add Mark Done Button logic
        const markDoneBtn = document.createElement('button');
        markDoneBtn.id = 'mark-done-btn';
        markDoneBtn.style.padding = '12px 20px';
        markDoneBtn.style.borderRadius = '12px';
        markDoneBtn.style.border = 'none';
        markDoneBtn.style.background = '#238636';
        markDoneBtn.style.color = '#fff';
        markDoneBtn.style.cursor = 'pointer';
        markDoneBtn.style.fontSize = '1rem';
        markDoneBtn.style.fontWeight = '600';
        markDoneBtn.style.width = '100%';
        markDoneBtn.textContent = 'Mark as Done';

        markDoneBtn.addEventListener('click', () => {
            const day = getDayNumber();
            const log = loadCompletion();
            const newState = !log[day]; // Toggle
            saveDayCompletion(day, newState);
        });

        // --- Data Management (Export/Import) ---
        const dataContainer = document.createElement('div');
        dataContainer.style.display = 'flex';
        dataContainer.style.gap = '10px';
        dataContainer.style.justifyContent = 'center';
        dataContainer.style.marginTop = '10px';

        const btnStyle = 'background: rgba(48, 54, 61, 0.5); border: 1px solid #30363d; color: #8b949e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.8rem;';

        const exportBtn = document.createElement('button');
        exportBtn.textContent = 'Export Data';
        exportBtn.style.cssText = btnStyle;
        exportBtn.onclick = () => {
            const data = {
                log: loadCompletion(),
                startDate: localStorage.getItem(START_DATE_KEY)
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview-prep-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        };

        const importInput = document.createElement('input');
        importInput.type = 'file';
        importInput.accept = '.json';
        importInput.style.display = 'none';
        importInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.log) localStorage.setItem(COMPLETION_KEY, JSON.stringify(data.log));
                    if (data.startDate) localStorage.setItem(START_DATE_KEY, data.startDate);
                    alert('Data imported successfully! reloading...');
                    location.reload();
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
        };

        const importBtn = document.createElement('button');
        importBtn.textContent = 'Import Data';
        importBtn.style.cssText = btnStyle;
        importBtn.onclick = () => importInput.click();

        dataContainer.appendChild(exportBtn);
        dataContainer.appendChild(importBtn);
        dataContainer.appendChild(importInput);

        actionWrapper.appendChild(markDoneBtn);
        actionWrapper.appendChild(dataContainer);

        actionWrapper.appendChild(dataContainer);

        // Insert wrapper before footer text
        const footer = document.querySelector('.footer');
        footer.insertBefore(actionWrapper, footer.firstChild);

        // --- History Logic ---
        const historyBtn = document.getElementById('history-btn');
        const modal = document.getElementById('history-modal');
        const closeBtn = document.querySelector('.close-btn');
        const historyList = document.getElementById('history-list');

        historyBtn.onclick = () => {
            modal.style.display = "block";
            renderHistory();
        }

        closeBtn.onclick = () => {
            modal.style.display = "none";
        }

        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function renderHistory() {
            historyList.innerHTML = '';
            const currentDay = getDayNumber();
            const log = loadCompletion();

            for (let d = 1; d <= currentDay; d++) {
                const task = getTaskForDay(d);
                const isDone = log[d];

                const li = document.createElement('li');
                li.className = 'history-item';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'history-info';

                const daySpan = document.createElement('span');
                daySpan.className = 'history-day';
                daySpan.textContent = `Day ${d} ‚Ä¢ ${task.type}`;

                const titleLink = document.createElement('a');
                titleLink.className = 'history-title';
                titleLink.href = task.type === 'Coding' ? task.link : `https://www.google.com/search?q=${encodeURIComponent(task.title + " system design")}`;
                titleLink.target = '_blank';
                titleLink.textContent = task.title;
                if (isDone) {
                    titleLink.style.textDecoration = 'line-through';
                    titleLink.style.opacity = '0.5';
                }

                infoDiv.appendChild(daySpan);
                infoDiv.appendChild(titleLink);

                const checkBox = document.createElement('input');
                checkBox.type = 'checkbox';
                checkBox.className = 'history-check';
                checkBox.checked = !!isDone;
                checkBox.onchange = () => {
                    saveDayCompletion(d, checkBox.checked);
                };

                li.appendChild(infoDiv);
                li.appendChild(checkBox);
                historyList.appendChild(li);
            }
        }

        // --- Custom Topic Button Handlers ---
        document.getElementById('set-topic-btn').addEventListener('click', () => {
            const day = getDayNumber();
            const input = document.getElementById('custom-topic-input').value.trim();
            if (input) {
                saveCustomTopic(day, input);
                render();
            }
        });

        document.getElementById('custom-topic-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('set-topic-btn').click();
            }
        });

        document.getElementById('clear-topic-btn').addEventListener('click', () => {
            const day = getDayNumber();
            saveCustomTopic(day, null);
            render();
        });

        // --- Sync UI ---
        function buildSyncUI() {
            const syncSection = document.createElement('div');
            syncSection.className = 'sync-section';

            const code = getSyncCode() || '------';
            syncSection.innerHTML = `
                <div class="sync-box">
                    <div class="sync-header">
                        <span class="sync-label">‚òÅÔ∏è Cloud Sync</span>
                        <span class="sync-status" id="sync-status">
                            <span class="dot offline" id="sync-dot"></span>
                            <span id="sync-status-text">Connecting...</span>
                        </span>
                    </div>
                    <div class="sync-code-row">
                        <input type="text" class="sync-code-display" id="sync-code-input"
                            value="${code}" maxlength="6" placeholder="Enter code"
                            spellcheck="false" autocomplete="off">
                        <button class="sync-copy-btn" id="sync-copy-btn" title="Copy code">üìã</button>
                        <button class="sync-link-btn" id="sync-link-btn" title="Link device">üîó</button>
                    </div>
                    <div class="sync-hint">Enter the same code on another device to sync</div>
                </div>
            `;

            // Insert into the action wrapper in the footer
            actionWrapper.appendChild(syncSection);

            // Copy button
            document.getElementById('sync-copy-btn').addEventListener('click', () => {
                const input = document.getElementById('sync-code-input');
                navigator.clipboard.writeText(input.value).then(() => {
                    const btn = document.getElementById('sync-copy-btn');
                    btn.textContent = '‚úÖ';
                    setTimeout(() => btn.textContent = 'üìã', 1500);
                });
            });

            // Link button ‚Äî apply a new sync code from the input
            document.getElementById('sync-link-btn').addEventListener('click', async () => {
                const input = document.getElementById('sync-code-input');
                const newCode = input.value.toUpperCase().trim();
                if (newCode.length !== 6) {
                    alert('Sync code must be 6 characters');
                    return;
                }

                // Upload current local data to the new sync path first
                changeSyncCode(newCode);
                await uploadAllLocal([COMPLETION_KEY, CUSTOM_TOPIC_KEY]);

                // Pull remote data (merge)
                await pullData(COMPLETION_KEY);
                await pullData(CUSTOM_TOPIC_KEY);

                // Re-register listeners
                setupRealtimeListeners();
                render();

                const btn = document.getElementById('sync-link-btn');
                btn.textContent = '‚úÖ';
                btn.classList.add('active');
                setTimeout(() => {
                    btn.textContent = 'üîó';
                    btn.classList.remove('active');
                }, 2000);
            });
        }

        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-status-text');
            const input = document.getElementById('sync-code-input');
            if (!dot || !text) return;

            if (status.online) {
                dot.className = 'dot online';
                text.textContent = 'Synced';
                text.style.color = '#3fb950';
            } else {
                dot.className = 'dot offline';
                text.textContent = 'Offline';
                text.style.color = '#f85149';
            }

            if (status.code && input) {
                input.value = status.code;
            }
        }

        function setupRealtimeListeners() {
            onDataChange(COMPLETION_KEY, (data) => {
                // Remote change came in ‚Äî update local and re-render
                render();
            });
            onDataChange(CUSTOM_TOPIC_KEY, (data) => {
                render();
            });
        }

        // --- Init ---
        async function initApp() {
            checkTimerRecovery();
            render();
            buildSyncUI();

            // Initialize Firebase
            const hasConfig = FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY';
            if (hasConfig) {
                const code = initSync(FIREBASE_CONFIG, updateSyncStatus);
                if (code) {
                    // Pull remote data on startup
                    await pullData(COMPLETION_KEY);
                    await pullData(CUSTOM_TOPIC_KEY);
                    setupRealtimeListeners();
                    render();
                }
            } else {
                updateSyncStatus({ online: false, code: getSyncCode() || '------' });
                const hint = document.querySelector('.sync-hint');
                if (hint) hint.textContent = 'Add Firebase config to enable sync';
            }
        }

        initApp();

        // Service Worker Reg
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW Registered'))
                .catch(e => console.log('SW Fail', e));
        }
    </script>
</body>

</html>